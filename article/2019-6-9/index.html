<!doctype html>
<html class="no-js" lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Jonathan Chen">
        <meta name="description" content="Keep curious!">
        <meta name="keywords" content="blog, technology, python, pythonista, programming, developer, software developer, software engineer, azure, cloud, cloud computing, testing, clean code">
        <meta name="generator" content="Hugo 0.54.0" />
        <title> ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨ | Jonathan Chen&#39;s Blog</title>
        <meta name="description" content="ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨ - Keep curious!">
        <meta itemprop="name" content="ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨">
        <meta itemprop="description" content="ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨ - Keep curious!">
        <meta property="og:title" content="ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨">
        <meta property="og:description" content="ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨ - Keep curious!">
        <meta property="og:image" content="https://www.gravatar.com/avatar/73e7f10f7883ff287d4571c4c190fd93?size=200">
        <meta property="og:url" content="https://mscb402.github.io/article/2019-6-9/">
        <meta property="og:site_name" content="Jonathan Chen&#39;s Blog">
        <meta property="og:type" content="article">
        <link rel="icon" type="image/png" href="https://mscb402.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://mscb402.github.io/favicon-16x16.png" sizes="16x16">

	

        
        <link rel="stylesheet" href="https://mscb402.github.io/sass/theme.min.7f4b7ce40e75c56b2479c669b6e33cd1381e870b71fcf495203cc50ba0259faa.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav>

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://github.com/mscb402" target="_blank">Github</a></li>
                
            
                
                    <li><a href="/page/about/">å…³äºæˆ‘</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="/page/about/" class="logo">
                
                    <img src="https://www.gravatar.com/avatar/73e7f10f7883ff287d4571c4c190fd93?d=mm&size=200" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="/">Jonathan Chen&#39;s Blog</a>
            </h3>
            
                <span class="subtitle">Keep curious!</span>
            
            <h3 class="title">
                <div class="social-media">
                    
                        <a href="https://twitter.com/chenbeng1" target="_blank"><i class="fa fa-twitter"></i></a>
                    
                    
                        <a href="https://github.com/mscb402" target="_blank"><i class="fa fa-github"></i></a>
                    
                    
                    
                    
                </div>
            </h3>
        </div>

    

        
        <div class="toggler">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
     
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="/article/2019-6-9/">
    <i class="fa fa-fw fa-pencil"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="/article/2019-6-9/">ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-06-09</span>
            
        

        

        
            <span class="categories">
                
                    <a href="/categories/%E6%8A%80%E6%9C%AF">æŠ€æœ¯</a>
                
                    <a href="/categories/redis">Redis</a>
                
                    <a href="/categories/javascript">JavaScript</a>
                
            </span>
        

        
            <span class="author"><a href="/author/jonathan-chen">Jonathan Chen</a></span>
        
    </div>

    
        

<p>RateLimitæˆªæµå™¨ï¼Œå…¶å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„ä¸œè¥¿ã€‚ä»–å¯ä»¥é˜²æ­¢æŸäº›APIè¢«ç›—åˆ·ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¹³å¸¸éƒ½ä¼šéœ€è¦â€œå‘é€æ‰‹æœºçŸ­ä¿¡éªŒè¯ç â€çš„APIï¼Œè¿™éƒ½æ˜¯éœ€è¦æŒ‰æ¬¡æ•°æ”¶è´¹çš„ï¼Œè€Œä¸”ç›¸å¯¹æ¥è¯´ä»·æ ¼ä¹ŸæŒºæ˜‚è´µã€‚å¦‚æœä¸åŠ ä»¥é™åˆ¶ï¼Œé‚£åˆ†åˆ†é’Ÿè¢«åˆ·çˆ†ã€‚æœ‰å¯èƒ½ä¼šè¢«æŸäº›ä¸æ³•åˆ†å­ç”¨äºçŸ­ä¿¡ç‚¸å¼¹çš„éæ³•ç”¨é€”ï¼Œæˆ–è€…æœ‰äº›äººåªæ˜¯å•çº¯çš„å¯¹ç½‘ç«™è¿›è¡Œæ”»å‡»ï¼Œå¢åŠ å¹³å°çš„æ”¯å‡ºã€‚å½“ç„¶è¿™äº›éƒ½æœ‰å¾ˆå¤šç§æ–¹æ³•å»é˜²èŒƒï¼Œæœ€ç®€å•çš„å°±æ˜¯åŠ ä¸€ä¸ªéªŒè¯ç äº†ã€‚</p>

<p>ä¸è¿‡ä½œä¸ºAPIåº•å±‚ï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦åšå¥½ä¸‡å…¨çš„å‡†å¤‡ï¼Œä¸èƒ½çœŸçš„ç­‰å‡ºé—®é¢˜äº†æ‰å¼€å§‹é˜²èŒƒã€‚æˆ‘ä»¬å¯ä»¥ä¸€å¼€å§‹å°±é™åˆ¶æŸä¸ªAPIæ¥å£ç­‰æœ€å¤§è¯·æ±‚é‡ã€‚</p>

<p>è¿™æœ‰ä¸¤ä¸ªå¥½å¤„ã€‚</p>

<p>ç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥åœ¨å‰é¢çš„é˜²å®ˆéƒ½å¤±è´¥ä»¥åï¼Œä¿è¯æœ€åä¸€å±‚â€œå ¡å’â€ä¸ä¼šè¢«æ”»ä¸‹ï¼Œå¯ä»¥æŠŠæŸå¤±é™åˆ°æœ€ä½ã€‚</p>

<p>ç¬¬äºŒä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥ä¿è¯æœåŠ¡å™¨ç¨³å®šè¿è¡Œï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½æœ‰ä¸€å®šçš„æ‰¿å—é‡ï¼Œä¸€æ—¦æµé‡è¿‡å¤§ï¼ˆå¯èƒ½æ˜¯CCæ”»å‡»ï¼Œä¹Ÿå¯èƒ½æ˜¯æ­£å¸¸ç”¨æˆ·ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨äº§ç”ŸOutOfMemoryç­‰é”™è¯¯ï¼Œè¿™ä¼šè®©ç¨‹åºæˆ–è€…ç³»ç»Ÿå¥”æºƒã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå°†ä¼šå½±å“å¤§æ‰¹é‡çš„ç”¨æˆ·ã€‚</p>

<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªæˆªæµå™¨æ¥è´Ÿè´£æµé‡çš„è¿‡æ»¤ã€‚è¿‡æ»¤ä»¥åå¯ä»¥é€šè¿‡ä¸€äº›æ§åˆ¶ï¼ŒæŠŠæµé‡è½¬ç§»åˆ°å¦å¤–ä¸€å°ç©ºé—²çš„æœåŠ¡å™¨ä¸Šï¼Œå½“ç„¶ç›´æ¥æ‹’ç»è¯·æ±‚ä¹Ÿå¯ä»¥ï¼ˆå¦‚æœä½ ä»¬è€æ¿æ²¡æ„è§çš„è¯ï¼‰ã€‚</p>

<h1 id="æ­£æ–‡">æ­£æ–‡</h1>

<p><strong>RateLimitï¼Œè¿™ä¸ªæ˜¯æˆ‘å‰å‡ ä¸ªæœˆåœ¨åº”è˜æŸå®¶å…¬å¸æ—¶å€™å‡ºçš„ç¬”è¯•é¢˜ã€‚ä»Šå¤©æ— æ„ä¸­ç¿»åˆ°ï¼Œæ‰€ä»¥ï¼Œæ‹¿å‡ºæ¥ä¸å„ä½åˆ†äº«åˆ†äº«ã€‚</strong></p>

<p>ä»¥ä¸‹æ˜¯å…¬å¸çš„ç¬”è¯•é¢˜ç›®ï¼š</p>

<blockquote>
<p>ç”¨ Redis å’Œ Typescript / JavaScript å®ç°ä¸€ä¸ª RateLimit é™åˆ¶å™¨ï¼Œå¯ä»¥æŒ‡å®šäº‹ä»¶ã€é™åˆ¶æ—¶é—´ã€é™åˆ¶æ¬¡æ•°ï¼Œä¾‹å¦‚é™åˆ¶ 1 åˆ†é’Ÿå†…æœ€å¤š 3 æ¬¡è·å–çŸ­ä¿¡éªŒè¯ç ï¼Œæˆ– 10 åˆ†é’Ÿå†…æœ€å¤šä¸€æ¬¡é‡ç½®å¯†ç ã€‚</p>

<p>å¯ä»¥å®ç°ä¸ºä¸€ä¸ª express çš„ä¸­é—´ä»¶ã€‚</p>
</blockquote>

<h3 id="åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</h3>

<p>æˆªæµå™¨çš„å®ç°ï¼Œç½‘ç»œä¸Šæœ‰å¾ˆå¤šã€‚ä»¥å‰æœ‰äº†è§£è¿‡ä¸€ç§åŸºäºâ€œä»¤ç‰Œæ¡¶â€çš„æˆªæµç®—æ³•ã€‚ä¹Ÿç¡®å®æ•ˆæœä¸é”™ã€‚ä½†æ˜¯å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼Œéœ€è¦å¦å¤–å¼€ä¸€ä¸ªç¨‹åºå»ä¸æ–­çš„åˆ·æ–°ä»¤ç‰Œæ¡¶å†…çš„ä»¤ç‰Œæ•°é‡ï¼Œå…¶å®ä¹Ÿæ˜¯è›®è€—è´¹èµ„æºçš„ã€‚å½“ç„¶åˆç†çš„å®ç°æŠ€å·§ï¼Œä¸ä¼šå¤ªå·®ã€‚æˆ‘ä¸»è¦æ˜¯è§‰å¾—â€œä»¤ç‰Œæ¡¶â€ä¸æ˜¯é€‚åˆè¿™ä¸ªé¢˜ç›®çš„æƒ…å¢ƒã€‚æˆ‘ä¸ªäººæ˜¯æ¯”è¾ƒå–œæ¬¢ç®€æ´çš„ä¸œè¥¿ï¼Œå¦‚æœèƒ½æ›´åŠ ç®€æ´æ–¹ä¾¿çš„å®ç°è¿™ç§åŠŸèƒ½ï¼Œå¹¶ä¸ä¸€å®šè¦æå¾—é‚£ä¹ˆéº»çƒ¦ã€‚è‡³å°‘åœ¨ç›®å‰è¿™ä¸ªéœ€æ±‚ä¸‹ä¹Ÿè®¸å¹¶ä¸æ˜¯ç‰¹åˆ«é€‚åˆã€‚</p>

<p>ä»£ç é‡Œçš„è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯æˆ‘è„‘å­ä¸€ä¸‹å­å°±æƒ³åˆ°çš„ï¼Œä¹Ÿè®¸å¹¶ä¸å¾ˆå®Œç¾ï¼Œæœ‰æˆ‘è€ƒè™‘ä¸å¤Ÿå‘¨åˆ°çš„åœ°æ–¹ã€‚</p>

<p>ä¸»è¦æ€æƒ³æ˜¯ï¼Œä¸ºæ¯ä¸€ä¸ªäº‹ä»¶å»ºç«‹ä¸€ä¸ªRedisçš„listé”®ã€‚æ¯ä¸€æ¬¡è¯·æ±‚å‘é€è¿‡æ¥ï¼Œå»å–listçš„ç¬¬å‰Nä¸ªç´¢å¼•ï¼Œè¿™é‡Œçš„Næ˜¯<strong>é™åˆ¶çš„æ¬¡æ•°</strong>ï¼Œå¦‚æœé™åˆ¶2æ¬¡ï¼ŒNå°±æ˜¯2ã€‚æ¯ä¸€ä¸ªLISTçš„å€¼ä¿å­˜çš„æ˜¯è¯·æ±‚åˆ°è¾¾çš„æ—¶é—´ï¼Œç¬¬å‰Nä¸ªç´¢å¼•ï¼Œå°±æ˜¯ç¬¬å‰Næ¬¡è¯·æ±‚åˆ°è¾¾çš„æ—¶é—´ã€‚å¦‚æœè¿™ä¸ªæ—¶é—´å’Œå½“å‰çš„æ—¶é—´ç›¸å‡çš„expireå°äº<strong>é™åˆ¶æ—¶é—´</strong>ï¼Œé‚£ä»€ä¹ˆè§„å®šæ—¶é—´å†…ï¼Œè¯·æ±‚å·²ç»åˆ°è¾¾ä¸Šé™ï¼Œå¯¹å…¶é˜»æ­¢ã€‚</p>

<p>å¯èƒ½è¡¨è¿°çš„è¿˜æ˜¯ä¸å¤Ÿæ¸…æ™°ï¼Œç›´è§‚ã€‚å¯ä»¥ç›´æ¥çœ‹<code>redis.lua</code>é‡Œçš„ä»£ç ï¼Œæ¯•ç«Ÿâ€˜talk is cheapï¼Œshow me the codeâ€™ğŸ˜Š</p>

<h3 id="ä»£ç ç»“æ„">ä»£ç ç»“æ„</h3>

<p>./eventBuilder.js äº‹ä»¶æ„å»ºå™¨ï¼Œæ–¹ä¾¿ç”ŸæˆæŒ‡å®šäº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹</p>

<pre><code class="language-javascript">class eventBuilder{
    constructor(){
        this.event_name = ''; //äº‹ä»¶åç§°ï¼Œä¾¿äºåˆ†è¾¨
        this.event_id = &quot;&quot;; //äº‹ä»¶IDï¼Œéœ€è¦è‡ªå®šä¹‰ï¼Œæ•°å­—å’Œè‹±æ–‡ç»„åˆ
        this.limit_count = 60; //é™åˆ¶æµé‡æˆªæµæ•°é‡
        this.time_period = 60; //é™åˆ¶æµé‡æˆªæµå‘¨æœŸï¼Œå•ä½ä¸ºç§’
    }
    /** äº‹ä»¶åç§° */
    EventName(data){
        this.event_name = data;
        return this;
    }
    /** äº‹ä»¶IDï¼Œæ•°å­—å’Œè‹±æ–‡ç»„åˆ */
    EventID(data){
        this.event_id = data;
        return this;
    }
    /** é™åˆ¶æµé‡æˆªæµæ•°é‡  */
    LimitCount(data){
        this.limit_count = data;
        return this;
    }
    /** é™åˆ¶æµé‡æˆªæµå‘¨æœŸï¼Œå•ä½ä¸ºç§’ */
    TimePeriod(data){
        this.time_period = data;
        return this;
    }
    
}
module.exports = new eventBuilder();
</code></pre>

<p>./rateLimit.js æˆªæµå™¨æºä»£ç ã€‚ä»£ç å¦‚ä¸‹</p>

<pre><code class="language-javascript">const app = require('express');
const redis = require(&quot;redis&quot;);
const fs = require(&quot;fs&quot;)
const {promisify} = require('util');
var client = redis.createClient();
/**
 * æˆªæµå™¨
 */
class rateLimit{

     constructor(){
        //åˆå§‹åŒ–
        this.hash = null;
        this.luaCode = fs.readFileSync('redis.lua');
        //å› ä¸ºè¯¥ä»£ç æ˜¯åœ¨ç¨‹åºå¼€å¯ååˆå§‹åŒ–çš„æ—¶å€™æ‰æ‰§è¡Œï¼Œæ‰€ä»¥é‡‡ç”¨åŒæ­¥è¯»å–ï¼Œä¸ä¼šå½±å“æ€§èƒ½ã€‚
        this.Event = {};
    }

    /**
     * å¯åŠ¨å‰ï¼Œå¿…é¡»è°ƒç”¨initï¼ŒåŠ è½½luaè„šæœ¬ã€‚å¦åˆ™æ— æ³•ä½¿ç”¨
     * è¿”å›ä¸€ä¸ªpromiseå¯¹è±¡
     */
    init(){
        //æ„å»ºpromise
        let client_script = promisify(client.script).bind(client);
        
        return client_script('load', this.luaCode)
        .then( (reply)=&gt;{

            this.hash = reply;

        }).catch(err =&gt;{

            console.log('err:'+err);

        });
    }

    /**
     * æ ¹æ®äº‹ä»¶IDè·å–å¯¹åº”çš„è·¯ç”±ï¼ŒæˆåŠŸè¿”å›è·¯ç”±ï¼Œå¤±è´¥è¿”å›null
     * @param {String} event_id äº‹ä»¶ID
     */
    getRouter(event_id){
        if(this.Event[event_id] === undefined){
            return null;
        }
        return this.Event[event_id].router;
    }

    /**
     * æ·»åŠ æ–°çš„äº‹ä»¶åˆ°æˆªæµå™¨ä¸­ï¼Œå»ºè®®ä½¿ç”¨eventBuilder
     * @param {Object} pros 
        pros{
            event_name:&quot;&quot;, //äº‹ä»¶åç§°ï¼Œä¾¿äºåˆ†è¾¨
            event_id:&quot;&quot;,   //äº‹ä»¶IDï¼Œéœ€è¦è‡ªå®šä¹‰ï¼Œæ•°å­—å’Œè‹±æ–‡ç»„åˆ
            limit_count:1, //é™åˆ¶æµé‡æˆªæµæ•°é‡
            time_period:60 //é™åˆ¶æµé‡æˆªæµå‘¨æœŸï¼Œå•ä½ä¸ºç§’
        }
     * @return index è¿”å›å¯¹åº”çš„index
     */
    addNewEvent(pros){
        if(pros['event_id'] === undefined){
            throw 'pros ERROR, please fix that!';
        }
        let event_id = pros.event_id;
        this.Event[event_id] = pros
        this.Event[event_id]['router'] = app.Router().use('/',this.limitFuncFactory(event_id));
        return true;
    }

    /**
     * æˆªæµå™¨å·¥å‚å‡½æ•°ï¼Œä¸“é—¨ç”¨äºç”Ÿäº§å¸¦æœ‰æˆªæµåŠŸèƒ½çš„è·¯ç”±å‡½æ•°
     * @param {String} event_id äº‹ä»¶ID
     */
    limitFuncFactory(event_id){

        let event = this.Event[event_id];

        return (req,res,next)=&gt;{
            let handle = (err,reply)=&gt;{

                if(err != null){
                    //å¦‚æœluaè„šæœ¬æ‰§è¡Œå‡ºç°é”™è¯¯ï¼Œä¹Ÿè¿›è¡Œæˆªæµ 
                    //ä¸€èˆ¬ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ
                    res.status(400).send(&quot;Limit&quot;);
                    console.log(&quot;Something wrong :&quot; + err);
                }

                //luaè„šæœ¬è¿”å›â€œOKâ€å’Œâ€œNOâ€ï¼Œokè¡¨ç¤ºå½“å‰æµé‡å¯ä»¥é€šè¿‡ã€‚
                if(reply == &quot;OK&quot;){
                    next()
                }else{
                    res.status(400).send(&quot;Limit&quot;);
                }

                
            }
            //æ‰§è¡Œå¯¹åº”çš„luaè„šæœ¬
            client.evalsha(this.hash, 1, event.event_id, event.limit_count, event.time_period, handle)
        }
        
    }
    
}

module.exports = new rateLimit();
</code></pre>

<p>./redis.lua è´Ÿè´£æˆªæµç®—æ³•çš„å®ç°ï¼Œä½¿ç”¨luaæ˜¯ä¸ºäº†èƒ½è®©rediså®ç°åŸå­æ“ä½œ.ã€‚ä»£ç å¦‚ä¸‹</p>

<pre><code class="language-lua">local eventX = 'EVENT_'..KEYS[1] --äº‹ä»¶ID--
local count = tonumber(ARGV[1]) --é™åˆ¶æ€»æ•°--
local nowTime = redis.call('TIME') --å½“å‰æ—¶é—´--
local t = nowTime[1] --å½“å‰æ—¶é—´æˆ³--
local expire = tonumber(ARGV[2]) --è¿‡æœŸæ—¶é—´ï¼Œç§’--

-- Passå‡½æ•°ï¼Œå½“æ¡ä»¶å…è®¸æ—¶ï¼Œå¤„ç†åäº‹ --
local function Pass()
  redis.call('LPUSH',eventX,t)
end

-- éœ€è¦æ¸…ç†ä¹‹å‰è¿‡æœŸçš„tokenï¼Œä¿ç•™å½“å‰ä¸ªæ•° --
local function Trim()
  redis.call('ltrim',eventX,0,count-1)
end

-- æ€»æ•°ä¸º0ï¼Œç›´æ¥å°±ç¦æ­¢è®¿é—® --
if(count == nil or count &lt;= 0)
then
  return 'NO'
end

-- è·å–å½“å‰äº‹ä»¶listçš„ä¸ªæ•°ï¼Œå°äºæ€»æ•°éƒ½å…è®¸ç›´æ¥é€šè¿‡ --
if(redis.call('LLEN',eventX) &lt; count)
then
  Pass()
  return 'OK'
end

local index = count - 1

-- è·å–ç¬¬countä¸ªå€¼é‡Œä¿å­˜çš„æ—¶é—´ --
local begin_time = redis.call('LINDEX',eventX,index)

-- æ—¶é—´ä¸ºç©ºï¼Œå¯èƒ½æ˜¯listä¸å¤Ÿå¤§ï¼Œç›´æ¥é€šè¿‡ --
if(begin_time == nil)
then
  Pass()
  return 'OK'
end

-- å½“å‰æ—¶é—´å‡å»ç¬¬countçš„æ—¶é—´ï¼Œå¦‚æœåœ¨è¿‡æœŸæ—¶é—´å†… --
-- è¡¨ç¤ºåœ¨ç»™å®šçš„è¿‡æœŸæ—¶é—´å†…ï¼Œæˆ‘ä»¬å…è®¸çš„æœ€å¤šcountä¸ªè®¿é—®å·²ç»å¡«æ»¡äº†--
-- æ‰€ä»¥ä¸å…è®¸è®¿é—® --
if(t - begin_time &lt;= expire)
then
  return 'NO'
else
  -- å¦åˆ™ï¼Œç›´æ¥pass --
  Pass()
  -- é¡ºæ‰‹æ¸…ç†ä¸€ä¸‹ä¹‹å‰çš„æ•°æ® --
  Trim() 
  return 'OK'
end
</code></pre>

<p>./index.js åˆ©ç”¨æˆªæµå™¨çš„ä¸€ä¸ªå°ä¾‹å­ï¼Œå¼€å¯æœ¬åœ°8088ç«¯å£ï¼Œå¹¶ä»¥ä¸­é—´ä»¶çš„å½¢å¼æ’å…¥åˆ° /test è·¯ç”±ä¸­</p>

<pre><code class="language-javascript">const express = require('express')
const app = express()
const rateLimit = require(&quot;./rateLimit&quot;)
const eventBuilder = require('./eventBuilder')

rateLimit.init().then(()=&gt;{
    //ç”Ÿæˆä¸€ä¸ª20ç§’å†…ï¼Œåªå…è®¸è®¿é—®2æ¬¡çš„äº‹ä»¶
    let event = eventBuilder.EventName(&quot;æµ‹è¯•æˆªæµ&quot;)
                            .EventID('testLimit')
                            .LimitCount(40)
                            .TimePeriod(5);

    //æ·»åŠ åˆ°æˆªæµå™¨ä¸­
    rateLimit.addNewEvent(event);

    //è·å¾—äº‹ä»¶çš„è·¯ç”±
    let rout = rateLimit.getRouter('testLimit')
    if(rout == null){
        throw &quot;è·¯ç”±å™¨ä¸ºç©º&quot;
    }
    
    //ä»¥ä¸­é—´ä»¶çš„å½¢åŠ¿æ’å…¥åˆ° /test è·¯ç”±ä¸­
    app.get('/test', [rout, (req,res)=&gt;{
        console.log('#');
        res.send(&quot;&lt;h1&gt;HELLO WORLD&lt;/h1&gt;&quot;);
    }] );


}).catch(err=&gt;{
    console.error(err)
})

app.listen('8088', () =&gt; console.log(`æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼`))

</code></pre>

<p><strong>éœ€è¦ä¾èµ–çš„åŒ…ï¼š</strong><code>&quot;express&quot;: &quot;^4.16.4&quot;</code>,<code>&quot;redis&quot;: &quot;^2.8.0&quot;</code></p>

<h2 id="æµ‹è¯•">æµ‹è¯•</h2>

<p>ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œåœ¨è·¯ç”±å†…è¾“å‡ºâ€˜#â€™ä½œä¸ºè¯·æ±‚çš„å“åº”ï¼ˆç¡®å®æ¯”è¾ƒå‚»ï¼Œè¿™ä¸ªæ–¹æ³•ã€‚æ•°çš„ç´¯æ­»ï¼‰</p>

<pre><code class="language-javascript">app.get('/test', [rout, (req,res)=&gt;{
        console.log('#');
        res.send(&quot;&lt;h1&gt;HELLO WORLD&lt;/h1&gt;&quot;);
    }] );
</code></pre>

<p>ä½¿ç”¨wrkè¿›è¡Œæµ‹è¯•</p>

<p>ç”µè„‘é…ç½®ï¼šMacBook air 2017ç‰ˆæœ¬</p>

<h3 id="å¯ç”¨æ€§æµ‹è¯•1">å¯ç”¨æ€§æµ‹è¯•1</h3>

<p>wrké…ç½®</p>

<pre><code>wrk -t 5 -c 20 -d 20 http://localhost:8088/test
</code></pre>

<p>5ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶ç»´æŒ20ä¸ªè¯·æ±‚ï¼ŒæŒç»­å‘¨æœŸ20ç§’</p>

<p>äº‹ä»¶é…ç½®ï¼š</p>

<p>20ç§’å†…ï¼Œ20ä¸ªå“åº”</p>

<pre><code class="language-js">let event = eventBuilder.EventName(&quot;æµ‹è¯•æˆªæµ&quot;)
                        .EventID('testLimit')
                        .LimitCount(20)
                        .TimePeriod(20);
</code></pre>

<p>æµ‹è¯•ç»“æœï¼š</p>

<p>wrkç»“æœ</p>

<pre><code>Running 20s test @ http://localhost:8088/test
  5 threads and 20 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.24ms    1.32ms  41.20ms   93.47%
    Req/Sec     1.26k   218.45     1.52k    82.20%
  125121 requests in 20.01s, 25.89MB read
  Non-2xx or 3xx responses: 125101
Requests/sec:   6251.45
Transfer/sec:      1.29MB
</code></pre>

<p>nodejsè¾“å‡ºï¼š</p>

<p>æ­£å¸¸ï¼Œè¾“å‡º20ä¸ªâ€œ#â€</p>

<h3 id="å¯ç”¨æ€§æµ‹è¯•2">å¯ç”¨æ€§æµ‹è¯•2</h3>

<p>wrké…ç½®</p>

<pre><code>wrk -t 5 -c 20 -d 5 http://localhost:8088/test
</code></pre>

<p>5ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶ç»´æŒ20ä¸ªè¯·æ±‚ï¼ŒæŒç»­å‘¨æœŸ5ç§’</p>

<p>äº‹ä»¶é…ç½®ï¼š</p>

<p>5ç§’å†…ï¼Œ40ä¸ªå“åº”</p>

<pre><code class="language-js">let event = eventBuilder.EventName(&quot;æµ‹è¯•æˆªæµ&quot;)
                        .EventID('testLimit')
                        .LimitCount(40)
                        .TimePeriod(5);
</code></pre>

<p>æµ‹è¯•ç»“æœï¼š</p>

<p>wrkç»“æœ</p>

<pre><code>Running 5s test @ http://localhost:8088/test
  5 threads and 20 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     4.09ms    2.52ms  43.84ms   94.64%
    Req/Sec     1.03k   234.50     1.40k    68.00%
  25550 requests in 5.01s, 5.29MB read
  Non-2xx or 3xx responses: 25510
Requests/sec:   5102.71
Transfer/sec:      1.06MB
</code></pre>

<p>nodejsè¾“å‡ºï¼š</p>

<p>æ­£å¸¸ï¼Œè¾“å‡º40ä¸ªâ€œ#â€</p>

<h3 id="æ­£ç¡®æ€§æµ‹è¯•-rediså†…æŸ¥çœ‹token">æ­£ç¡®æ€§æµ‹è¯•ï¼šrediså†…æŸ¥çœ‹token</h3>

<p>ä»£ç ï¼š<code>lrange EVENT_testLimit 0 -1</code></p>

<p>è¿”å›ï¼š40ä¸ªè¯·æ±‚æ—¶é—´æˆ³</p>

<pre><code> 1) &quot;1554893376&quot;
 2) &quot;1554893376&quot;
 3) &quot;1554893376&quot;
 4) &quot;1554893376&quot;
 5) &quot;1554893376&quot;
 6) &quot;1554893376&quot;
 7) &quot;1554893376&quot;
 8) &quot;1554893376&quot;
 9) &quot;1554893376&quot;
10) &quot;1554893376&quot;
11) &quot;1554893376&quot;
12) &quot;1554893376&quot;
13) &quot;1554893376&quot;
14) &quot;1554893376&quot;
15) &quot;1554893376&quot;
16) &quot;1554893376&quot;
17) &quot;1554893376&quot;
18) &quot;1554893376&quot;
19) &quot;1554893376&quot;
20) &quot;1554893376&quot;
21) &quot;1554893376&quot;
22) &quot;1554893376&quot;
23) &quot;1554893376&quot;
24) &quot;1554893376&quot;
25) &quot;1554893376&quot;
26) &quot;1554893376&quot;
27) &quot;1554893376&quot;
28) &quot;1554893376&quot;
29) &quot;1554893376&quot;
30) &quot;1554893376&quot;
31) &quot;1554893376&quot;
32) &quot;1554893376&quot;
33) &quot;1554893376&quot;
34) &quot;1554893376&quot;
35) &quot;1554893376&quot;
36) &quot;1554893376&quot;
37) &quot;1554893376&quot;
38) &quot;1554893376&quot;
39) &quot;1554893376&quot;
40) &quot;1554893376&quot;
</code></pre>

<h3 id="æ€»ç»“">æ€»ç»“</h3>

<p>ä»¥ä¸Šæµ‹è¯•è¯´æ˜ï¼Œåœ¨çŸ­æ—¶é—´å†…å¤§é‡çš„è¯·æ±‚åŒæ—¶å‘é€ï¼Œä¸ä¼šç ´åç¨‹åºçš„æ­£ç¡®æ€§å’Œå¯ç”¨æ€§ã€‚æœ€å¥½é€šè¿‡æŸ¥çœ‹rediså†…çš„æ•°æ®ï¼Œå¯ä»¥ç¡®ä¿ï¼Œä¸ä¼šå› ä¸ºè®¿é—®äººæ•°å¤ªå¤§è€Œï¼Œå ç”¨rediså¤§é‡çš„å†…å­˜ï¼Œå½±å“æ€§èƒ½ã€‚redisä¸‹æœ€å¤šåªä¼šä¿å­˜Nä¸ªè¯·æ±‚æ•°æ®ï¼ŒNè¡¨ç¤ºé™åˆ¶çš„è¯·æ±‚ä¸ªæ•°ã€‚</p>

<hr />

<p><em>æ³¨æ„ï¼šæœ¬æ–‡æœªç»è®¸å¯ï¼Œä¸å¾—è½¬è½½</em></p>

    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="/tags/ratelimit">RateLimit</a>
                
                    <a href="/tags/%E6%88%AA%E6%B5%81%E5%99%A8">æˆªæµå™¨</a>
                
                    <a href="/tags/redis">Redis</a>
                
                    <a href="/tags/javascript">JavaScript</a>
                
                    <a href="/tags/express">express</a>
                
            </div>
        </div>
    

    
</div>

</article>

        
    </div>

    
        
    

     

        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>æœ€æ–°å¸–å­</strong>
                <ul>
                
                    <li>
                        <a href="/article/2019-6-9/">ç”¨Rediså’ŒJavaScript/expresså®ç°ä¸€ä¸ªRateLimitæˆªæµå™¨</a>
                    </li>
                
                    <li>
                        <a href="/article/2019-6-8/">æ‹’ç»ç½‘ç»œæš´åŠ›ï¼åŸºäºæ·±åº¦å­¦ä¹ çš„ç½‘ç»œæ¬ºå‡Œæ£€æµ‹</a>
                    </li>
                
                    <li>
                        <a href="/article/2019-5-12/">PHPåç¨‹ä¹‹è·¯-åç¨‹å®ç°</a>
                    </li>
                
                    <li>
                        <a href="/article/2019-5-1/">PHPåç¨‹ä¹‹è·¯-äº‹ä»¶å¾ªç¯Event Loop</a>
                    </li>
                
                    <li>
                        <a href="/article/2019-4-21/">PHPåç¨‹ä¹‹è·¯-yield fromå’Œåç¨‹åˆæ­¥</a>
                    </li>
                
                    <li>
                        <a href="/article/2019-4-7/">PHPåç¨‹ä¹‹è·¯-yieldè¯­æ³•ç³–</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="/categories/"><strong>åˆ†ç±»</strong></a>
                <ul>
                
                    <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF">æŠ€æœ¯ (7)</a>
                    </li>
                
                    <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF%E6%A6%82%E5%BF%B5">æŠ€æœ¯æ¦‚å¿µ (4)</a>
                    </li>
                
                    <li>
                        <a href="/categories/php">Php (2)</a>
                    </li>
                
                    <li>
                        <a href="/categories/javascript">Javascript (1)</a>
                    </li>
                
                    <li>
                        <a href="/categories/python">Python (1)</a>
                    </li>
                
                    <li>
                        <a href="/categories/redis">Redis (1)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>ç¤¾äº¤åª’ä½“</strong>

                
                
                    <a href="https://twitter.com/chenbeng1" target="_blank"><i class="fa fa-twitter-adblock-proof"></i></a>
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/mscb402" target="_blank"><i class="fa fa-github"></i></a>
                
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/mscb402" target="_blank">
                &copy;
                
                    2019
                
                by Chen Beng (Jonathan Chen)
            </a>
	    
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="https://mscb402.github.io/js/externalDependencies.2a3cf2b558bd16302d997f6c20de885831fe6e39f05a054ddede6211a4a78d882081b58973893707bbefb74dc3611b37e66edb04bc5f075f4a198b2d135d96ae.js" integrity="sha512-KjzytVi9FjAtmX9sIN6IWDH&#43;bjnwWgVN3t5iEaSnjYgggbWJc4k3B7vvt03DYRs35m7bBLxfB19KGYstE12Wrg=="></script>

        
        
        <script type="text/javascript" src="https://mscb402.github.io/js/theme.ba9945b0c16d4ddb26fd4bd58193d268e92614f0c74cced07d6d8641ac7564d7.js" integrity="sha256-uplFsMFtTdsm/UvVgZPSaOkmFPDHTM7QfW2GQax1ZNc="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "zh-cn" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("ã€è¿”å›ã€‘");
        </script>

        
            
        

        


    </body>
</html>
